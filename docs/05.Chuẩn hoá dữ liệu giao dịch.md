A. Từ POS (bên bán hàng) bạn nhận kiểu:
Order: mã đơn POS, thời điểm tạo, cửa hàng/chi nhánh, cashier

Line items: danh sách món/hàng (tên, qty, unit price, discount, combo…)

Tổng tiền: subtotal/discount/service charge/VAT (nếu POS có tính trước)

Thông tin người mua (nếu có): tên, MST, email/SDT, địa chỉ

Trạng thái đơn: created/paid/canceled/refunded… (tùy POS)

Vấn đề: mỗi POS đặt tên field khác nhau, cách tính discount/fee khác nhau.
B. Từ PSP/VNPAY (bên thanh toán) bạn nhận kiểu:
Payment transaction: paymentId/txnRef, amount, method (QR/card…), status (success/fail/pending)

Timestamp: paidAt, callbackAt

Reference: orderRef (tham chiếu về POS) hoặc invoiceRef (tham chiếu về bạn)

Refund: refundId, refundAmount, refundStatus

Vấn đề: status/luồng callback có thể đến trễ, trùng, hoặc out-of-order.
C. Chuẩn hoá = tạo “Canonical Schema” (schema chuẩn nội bộ)
Bạn thiết kế 1 model chuẩn, ví dụ tách thành 3 khối:
Order (sự kiện bán hàng từ POS)

Payment (sự kiện thanh toán từ PSP)

Invoice Request/Invoice (yêu cầu + kết quả phát hành HĐĐT)

Ví dụ schema chuẩn (minh hoạ):
{
"merchantId": "M123",
"storeId": "S01",
"order": {
"orderId": "POS-20260115-0008",
"createdAt": "2026-01-15T10:05:12+07:00",
"currency": "VND",
"items": [
{
"sku": "CF-SUA-DA",
"name": "Cà phê sữa đá",
"qty": 2,
"unitPrice": 25000,
"discount": 0,
"taxCategory": "VAT_8"
}
],
"charges": {
"serviceCharge": 0,
"shippingFee": 0,
"orderDiscount": 0
},
"amounts": {
"subtotal": 50000,
"tax": 4000,
"total": 54000
},
"buyer": {
"name": null,
"taxCode": null,
"email": null
}
},
"payment": {
"psp": "VNPAY",
"paymentId": "VNP-88990011",
"orderRef": "POS-20260115-0008",
"amount": 54000,
"status": "SUCCEEDED",
"paidAt": "2026-01-15T10:06:01+07:00"
}
}
