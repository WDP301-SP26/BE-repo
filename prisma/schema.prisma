// 1. Cấu hình chung
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 2. Định nghĩa các Enum
enum Role {
  STUDENT
  GROUP_LEADER
  LECTURER
  ADMIN
}

enum AuthProvider {
  EMAIL
  GITHUB
  JIRA
}

enum IntegrationProvider {
  GITHUB
  JIRA
  ATLASSIAN
}

enum GroupStatus {
  ACTIVE
  ARCHIVED
  COMPLETED
}

enum MembershipRole {
  MEMBER
  LEADER
  MENTOR
}

// 3. Model USER - Central user table for authentication & identity
model User {
  id                String        @id @default(uuid()) @db.Uuid
  student_id        String?       @unique @db.VarChar(100) // Optional to support OAuth-created accounts
  email             String        @unique @db.VarChar(255)
  password_hash     String?       @db.VarChar(255) // Nullable for OAuth-only users
  full_name         String?       @db.VarChar(100)
  primary_provider  AuthProvider  @default(EMAIL) // Tracks how user initially registered
  role              Role          @default(STUDENT)
  is_email_verified Boolean       @default(false)
  created_at        DateTime      @default(now()) @db.Timestamptz(6)
  updated_at        DateTime      @updatedAt @db.Timestamptz(6)
  last_login        DateTime?     @db.Timestamptz(6)
  avatar_url        String?       @db.VarChar(255)

  // Quan hệ
  integrationTokens IntegrationToken[]
  createdGroups     Group[]            @relation("GroupCreator")
  memberships       GroupMembership[]

  @@map("User")
}

// 4. Model INTEGRATION_TOKEN - OAuth tokens for both authentication AND API access
model IntegrationToken {
  id                String               @id @default(uuid()) @db.Uuid
  user_id           String               @db.Uuid
  provider          IntegrationProvider
  provider_user_id  String               @db.VarChar(255) // OAuth provider's user ID (e.g., GitHub user ID)
  provider_username String?              @db.VarChar(255) // Username/login on provider (for display)
  provider_email    String?              @db.VarChar(255) // Email from OAuth provider
  access_token      String               @db.Text // Store encrypted in production!
  refresh_token     String?              @db.Text // Store encrypted if provided
  token_expires_at  DateTime?            @db.Timestamptz(6)
  scope             String?              @db.Text // comma-separated scopes or JSON string
  used_for_login    Boolean              @default(false) // True if this is used for authentication
  created_at        DateTime             @default(now()) @db.Timestamptz(6)
  updated_at        DateTime             @updatedAt @db.Timestamptz(6)
  last_refreshed_at DateTime?            @db.Timestamptz(6)

  // Quan hệ
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, provider]) // Prevent duplicate OAuth connections
  @@unique([provider, provider_user_id]) // Prevent same OAuth account linking to multiple users
  @@map("IntegrationToken")
}

// 5. Model GROUP - Minimal group entity
model Group {
  id              String      @id @default(uuid()) @db.Uuid
  name            String      @db.VarChar(100)
  semester        String?     @db.VarChar(20) // e.g. 2025-1 or HK2-2025
  created_by_id   String      @db.Uuid
  status          GroupStatus @default(ACTIVE)
  github_repo_url String?     @db.VarChar(255) // Full https://github.com/owner/repo url
  jira_project_key String?    @db.VarChar(50)
  created_at      DateTime    @default(now()) @db.Timestamptz(6)
  updated_at      DateTime    @updatedAt @db.Timestamptz(6)

  // Quan hệ
  creator User              @relation("GroupCreator", fields: [created_by_id], references: [id])
  members GroupMembership[]

  @@map("Group")
}

// 6. Model GROUP_MEMBERSHIP - Many-to-many link between users and groups with role
model GroupMembership {
  group_id      String         @db.Uuid
  user_id       String         @db.Uuid
  role_in_group MembershipRole @default(MEMBER)
  joined_at     DateTime       @default(now()) @db.Timestamptz(6)
  left_at       DateTime?      @db.Timestamptz(6)

  // Quan hệ
  group Group @relation(fields: [group_id], references: [id])
  user  User  @relation(fields: [user_id], references: [id])

  @@unique([group_id, user_id], name: "group_membership_unique")
  @@map("GroupMembership")
}